# ADR 007: Database Partitioning Strategy

<!-- Generated by Copilot -->

## Status

**Accepted**

## Context

The Transaction table will grow to millions/billions of records over time:

- Average user: ~500 transactions/year
- 100,000 users: 50M transactions/year
- After 5 years: 250M+ transactions

We need a partitioning strategy that:

- Optimizes query performance for date-range queries
- Enables efficient data archival
- Maintains system scalability
- Minimizes operational complexity

## Decision

We will use **RANGE partitioning by TransactionDate** with **quarterly intervals**, managed by **pg_partman**.

### Partitioning Scheme

```sql
CREATE TABLE transactions (
    id UUID NOT NULL,
    wallet_id UUID NOT NULL,
    transaction_date TIMESTAMPTZ NOT NULL,
    -- other columns
    PRIMARY KEY (id, transaction_date)
) PARTITION BY RANGE (transaction_date);

-- Example partitions
CREATE TABLE transactions_2025_q1 
    PARTITION OF transactions 
    FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE transactions_2025_q2 
    PARTITION OF transactions 
    FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');
```

### Why Quarterly Intervals?

| Interval | Partitions (5 years) | Rows/Partition | Maintenance | Verdict |
|----------|---------------------|----------------|-------------|---------|
| Daily | 1,825 | ~137K | Too high | ❌ |
| Monthly | 60 | ~4.2M | Low | ✅ Good |
| Quarterly | 20 | ~12.5M | Very low | ✅ **Chosen** |
| Yearly | 5 | ~50M | Very low | ❌ Too coarse |

**Quarterly** balances:
- Manageable partition count
- Good query performance
- Natural alignment with business reporting
- Low operational overhead

### Why RANGE (not HASH or LIST)?

| Type | Pros | Cons | Verdict |
|------|------|------|---------|
| RANGE (date) | Query pruning, easy archival | Uneven distribution | ✅ **Chosen** |
| HASH (walletId) | Even distribution | No date pruning | ❌ |
| LIST (type) | Simple | Too few partitions | ❌ |

### Automation with pg_partman

```sql
-- Install pg_partman
CREATE EXTENSION pg_partman;

-- Configure automatic partition management
SELECT partman.create_parent(
    p_parent_table => 'public.transactions',
    p_control => 'transaction_date',
    p_type => 'range',
    p_interval => '3 months',
    p_premake => 4  -- Create 4 future partitions
);

-- Schedule maintenance (run daily)
SELECT partman.run_maintenance();
```

### Retention Policy

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Active Data    │     │   Cold Storage  │     │    Archive      │
│  (0-2 years)    │────▶│   (2-5 years)   │────▶│   (5+ years)    │
│  Fast SSD       │     │   Cheaper disk  │     │   S3/Glacier    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

- **0-2 years**: Active partitions on primary storage
- **2-5 years**: Move to cold storage (compressed)
- **5+ years**: Archive to object storage

## Consequences

### Positive

- **Performance**: Query pruning skips irrelevant partitions
- **Maintenance**: Fast VACUUM/ANALYZE per partition
- **Archival**: DROP PARTITION instead of slow DELETE
- **Scalability**: Handles billions of records efficiently

### Negative

- **Complexity**: Requires understanding of partitioning
- **Primary Key**: Must include partition key (transaction_date)
- **Cross-partition queries**: Can be slower
- **EF Core**: Requires careful configuration

### Mitigations

- pg_partman automates partition management
- Document partitioning constraints
- Monitor query plans for partition pruning
- Test cross-partition query performance

## Implementation Status

- [x] Strategy approved
- [ ] EF Core migration with partitioning
- [ ] pg_partman setup
- [ ] Monitoring and alerting
- [ ] Archive automation

## References

- [PostgreSQL Table Partitioning](https://www.postgresql.org/docs/current/ddl-partitioning.html)
- [pg_partman Documentation](https://github.com/pgpartman/pg_partman)
- [Detailed Strategy](../../how-to/creative-transaction-partitioning.md)

---

**Navigation**: [Previous: FastEndpoints](006-fastendpoints.md) | [Next: Soft Delete](008-soft-delete.md)
