# ADR 005: Centralized Error Handling

<!-- Generated by Copilot -->

## Status

**Accepted**

## Context

We need an error handling strategy that:

- Provides consistent error responses across all endpoints
- Logs errors appropriately for debugging
- Doesn't expose sensitive information to clients
- Handles both expected and unexpected errors

## Decision

We will implement **centralized error handling** using FastEndpoints and custom middleware.

### Error Categories

| Category | HTTP Status | Example |
|----------|-------------|---------|
| Validation Error | 400 | Invalid input data |
| Not Found | 404 | Transaction doesn't exist |
| Business Rule | 422 | Insufficient balance |
| Server Error | 500 | Unexpected exception |

### Error Response Format

```json
{
  "statusCode": 400,
  "message": "Validation failed",
  "errors": {
    "Amount": ["Amount must be greater than 0"],
    "Currency": ["Currency is required"]
  },
  "traceId": "00-abc123..."
}
```

### Implementation

**Global Exception Handler**:

```csharp
public class GlobalExceptionMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        try
        {
            await next(context);
        }
        catch (ValidationException ex)
        {
            await HandleValidationException(context, ex);
        }
        catch (NotFoundException ex)
        {
            await HandleNotFoundException(context, ex);
        }
        catch (Exception ex)
        {
            await HandleUnexpectedException(context, ex);
        }
    }
}
```

**Domain Exceptions**:

```csharp
// Custom exceptions in Domain layer
public class NotFoundException : Exception
{
    public NotFoundException(string entity, object key)
        : base($"{entity} with key {key} was not found.") { }
}

public class BusinessRuleException : Exception
{
    public BusinessRuleException(string message) : base(message) { }
}
```

**FluentValidation Integration**:

```csharp
public class CreateTransactionCommandValidator 
    : AbstractValidator<CreateTransactionCommand>
{
    public CreateTransactionCommandValidator()
    {
        RuleFor(x => x.Amount)
            .GreaterThan(0)
            .WithMessage("Amount must be greater than 0");
            
        RuleFor(x => x.Currency)
            .NotEmpty()
            .Length(3)
            .WithMessage("Currency must be a valid 3-letter ISO code");
    }
}
```

### Logging Strategy

| Level | When | Example |
|-------|------|---------|
| Debug | Detailed tracing | Query parameters, cache hits |
| Information | Normal operations | Request started/completed |
| Warning | Expected issues | Cache miss, retry attempt |
| Error | Failures | Database error, external service failure |
| Critical | System-level | Application startup failure |

```csharp
catch (Exception ex)
{
    _logger.LogError(ex, 
        "Unhandled exception processing request {RequestType}", 
        typeof(TRequest).Name);
    throw;
}
```

## Consequences

### Positive

- **Consistency**: All errors follow same format
- **Security**: Sensitive details hidden from clients
- **Debugging**: TraceId enables request correlation
- **Maintainability**: Error handling in one place

### Negative

- **Abstraction**: Harder to see error handling in endpoint code
- **Global scope**: Must be careful not to swallow important exceptions

### Mitigations

- Clear documentation of exception types
- Structured logging with correlation IDs
- Monitoring and alerting on error rates

## Error Handling Flow

```
Request
    │
    ▼
┌─────────────────────┐
│ Global Exception    │
│ Middleware          │
├─────────────────────┤
│                     │
│ ┌─────────────────┐ │
│ │   Endpoint      │ │
│ │                 │ │
│ │ ┌─────────────┐ │ │
│ │ │  Handler    │ │ │
│ │ │             │ │ │
│ │ │ ┌─────────┐ │ │ │
│ │ │ │ Domain  │ │ │ │
│ │ │ └─────────┘ │ │ │
│ │ └─────────────┘ │ │
│ └─────────────────┘ │
│                     │
└─────────────────────┘
    │
    ▼
Response (Success or Error)
```

## References

- [FastEndpoints Error Handling](https://fast-endpoints.com/docs/exception-handling)
- [FluentValidation](https://docs.fluentvalidation.net/)
- [Problem Details RFC 7807](https://datatracker.ietf.org/doc/html/rfc7807)

---

**Navigation**: [Previous: Hybrid Caching](004-hybrid-caching.md) | [ADR Index](../README.md)
