# Docker Setup Guide

<!-- Generated by Copilot -->

> **Goal**: Configure and manage the Docker environment for TransactionService

## Docker Compose Configuration

The project uses Docker Compose to manage infrastructure dependencies.

### Default Configuration

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:16
    container_name: transactionservice-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: transactiondb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: transactionservice-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

## Common Operations

### Start Infrastructure

```powershell
# Start in background
docker compose up -d

# Start with logs visible
docker compose up

# Start specific service
docker compose up -d postgres
```

### Stop Infrastructure

```powershell
# Stop containers (keep data)
docker compose down

# Stop and remove volumes (clean slate)
docker compose down -v

# Stop specific service
docker compose stop postgres
```

### View Logs

```powershell
# All services
docker compose logs

# Follow logs
docker compose logs -f

# Specific service
docker compose logs postgres
docker compose logs redis
```

### Check Status

```powershell
# Container status
docker compose ps

# Resource usage
docker stats
```

## Database Operations

### Connect to PostgreSQL

```powershell
# Interactive psql session
docker exec -it transactionservice-postgres psql -U postgres -d transactiondb

# Run single command
docker exec -it transactionservice-postgres psql -U postgres -c "SELECT * FROM \"Transactions\" LIMIT 5;"
```

### Backup and Restore

```powershell
# Backup
docker exec transactionservice-postgres pg_dump -U postgres transactiondb > backup.sql

# Restore
Get-Content backup.sql | docker exec -i transactionservice-postgres psql -U postgres -d transactiondb
```

### Reset Database

```powershell
# Drop and recreate
docker compose down -v
docker compose up -d postgres
# Wait for PostgreSQL to start
Start-Sleep -Seconds 5
# Run migrations
cd ExpenseVault.TransactionService.API
dotnet ef database update -p ../ExpenseVault.TransactionService.Infrastructure -s .
```

## Redis Operations

### Connect to Redis

```powershell
# Interactive redis-cli
docker exec -it transactionservice-redis redis-cli

# Check keys
docker exec -it transactionservice-redis redis-cli KEYS "transaction:*"

# Flush cache
docker exec -it transactionservice-redis redis-cli FLUSHALL
```

## Custom Configuration

### Using Different Ports

Create `docker-compose.override.yml`:

```yaml
services:
  postgres:
    ports:
      - "5433:5432"  # Use port 5433 on host
  
  redis:
    ports:
      - "6380:6379"  # Use port 6380 on host
```

Update `appsettings.Development.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5433;Database=transactiondb;Username=postgres;Password=postgres",
    "Redis": "localhost:6380"
  }
}
```

### Production-like Setup

```yaml
services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
```

## Troubleshooting

### Port Conflicts

```powershell
# Find process using port
Get-NetTCPConnection -LocalPort 5432 | Select-Object OwningProcess

# Use different port in docker-compose.override.yml
```

### Container Won't Start

```powershell
# Check logs
docker compose logs postgres

# Remove and recreate
docker compose rm -f postgres
docker compose up -d postgres
```

### Permission Issues (Windows)

```powershell
# Reset Docker Desktop
# Settings > Troubleshoot > Clean/Purge data
```

---

**Navigation**: [How-To Home](README.md) | [Documentation Map](../DOCUMENTATION_MAP.md)
